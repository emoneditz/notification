
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Control</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 500px; margin: 0 auto; background: #1a1a1a; color: #e0e0e0; }
        h2 { text-align: center; color: #fff; margin-bottom: 30px; }
        h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; color: #fff; }
        .section { background: #2d2d2d; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #444; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0 20px 0; border: 1px solid #555; border-radius: 8px; background: #222; color: white; box-sizing: border-box; font-size: 14px; outline: none; }
        label { font-size: 11px; color: #aaa; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        button { padding: 12px; cursor: pointer; border: none; border-radius: 8px; color: white; font-weight: bold; width: 100%; }
        .btn-send { background: linear-gradient(135deg, #28a745, #218838); height: 50px; font-size: 16px; text-transform: uppercase; }
        .btn-add { background: #0070f3; margin-bottom: 10px; }
        .btn-icon { background: #e0a800; color: black; }
        .btn-del { background: #ff4444; font-size: 12px; width: auto; padding: 6px 12px; margin-left: 8px; }
        .btn-edit { background: #17a2b8; font-size: 12px; width: auto; padding: 6px 12px; margin-left: auto; }
        .btn-use { background: #444; font-size: 12px; width: auto; padding: 6px 12px; }
        .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .hidden { display: none; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { padding: 12px; border-bottom: 1px solid #444; display: flex; align-items: center; justify-content: space-between; }
        .icon-preview { width: 32px; height: 32px; object-fit: contain; border-radius: 6px; margin-right: 12px; background: rgba(255,255,255,0.1); padding: 2px; }
        .toggle-label { display: flex; align-items: center; cursor: pointer; color: #fff; font-size: 14px; }
        .toggle-label input { width: auto; margin: 0 8px 0 0; }
    </style>
</head>
<body>

    <h2>üëë Ultimate Control</h2>

    <!-- TRANSMITTER -->
    <div class="section">
        <h3>üöÄ Transmit</h3>
        
        <label>1. Target</label>
        <select id="userSelect" onchange="loadUserPreferences()"></select>

        <label>2. Title</label>
        <input type="text" id="msgTitle" placeholder="Default: New Message">

        <label>3. Message</label>
        <textarea id="msgBody" rows="3" placeholder="Type message..."></textarea>

        <label>4. Action</label>
        <select id="clickAction" onchange="toggleUrlInput()">
            <option value="close">‚õî Do Nothing (Stealth)</option>
            <option value="open">üîó Open Website</option>
        </select>
        
        <input type="text" id="clickUrl" class="hidden" placeholder="Enter URL (https://...)">

        <div class="row" style="margin-top:15px; margin-bottom: 5px;">
            <label>5. Icon</label>
            <label class="toggle-label">
                <input type="checkbox" id="useIcon" onchange="toggleIcon()" checked> Enable
            </label>
        </div>
        <input type="text" id="currentIconUrl" placeholder="Icon URL..." onchange="updateUserPref()">
        
        <button class="btn-send" onclick="send()">SEND NOTIFICATION</button>
    </div>

    <!-- ICON LIBRARY -->
    <div class="section">
        <h3>üé® Icon Library</h3>
        <label>Add New</label>
        <div class="row">
            <input type="text" id="iconName" placeholder="Name" style="flex: 1;">
            <input type="text" id="iconUrl" placeholder="URL" style="flex: 2;">
        </div>
        <button class="btn-icon" onclick="saveIcon()">Save to Library</button>
        
        <div style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
            <ul id="iconList"></ul>
        </div>
    </div>

    <!-- USER MANAGER -->
    <div class="section">
        <h3>üë• Manage Users</h3>
        <label>Add New User</label>
        <input type="text" id="newUserName" placeholder="Name">
        <textarea id="newUserCode" placeholder='Paste Code JSON here...' rows="2"></textarea>
        <button class="btn-add" onclick="saveNewUser()">Save User</button>
        <div style="margin-top: 20px;"><ul id="manageUserList"></ul></div>
    </div>

    <script>
        let users = JSON.parse(localStorage.getItem('notifyUsers')) || [];
        
        // --- UPDATED ICONS (The Color Ones) ---
        let icons = JSON.parse(localStorage.getItem('notifyIcons')) || [
            { name: "WhatsApp", url: "https://cdn-icons-png.flaticon.com/512/733/733585.png" },
            { name: "Instagram", url: "https://cdn-icons-png.flaticon.com/512/174/174855.png" },
            { name: "Pinterest", url: "https://cdn-icons-png.flaticon.com/512/145/145808.png" }, // Reverted to Red P
            { name: "Facebook", url: "https://cdn-icons-png.flaticon.com/512/124/124010.png" },
            { name: "Messenger", url: "https://cdn-icons-png.flaticon.com/512/5968/5968771.png" }, // Reverted to Gradient
            { name: "Warning", url: "https://cdn-icons-png.flaticon.com/512/564/564619.png" }
        ];

        refreshAll();

        function refreshAll() {
            renderUserDropdown(); renderManageList(); renderIcons();
        }

        // --- CORE FUNCTIONS ---
        function toggleUrlInput() {
            const action = document.getElementById('clickAction').value;
            const input = document.getElementById('clickUrl');
            input.style.display = (action === 'open') ? 'block' : 'none';
        }

        async function send() {
            const index = document.getElementById('userSelect').value;
            if(index === "") return alert("Please select a user.");

            const msg = document.getElementById('msgBody').value;
            const title = document.getElementById('msgTitle').value;
            const useIcon = document.getElementById('useIcon').checked;
            const iconUrl = document.getElementById('currentIconUrl').value;
            const finalIcon = useIcon ? iconUrl : null;
            const action = document.getElementById('clickAction').value;
            const link = document.getElementById('clickUrl').value;

            if(!msg) return alert("Please enter a message.");

            const btn = document.querySelector('.btn-send');
            const originalText = btn.innerText;
            btn.innerText = "TRANSMITTING...";
            btn.style.opacity = "0.7";

            try {
                const res = await fetch('/api/notify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscription: users[index].sub,
                        message: msg,
                        title: title,
                        icon: finalIcon,
                        action: action,
                        link: link
                    })
                });
                if(res.ok) alert("‚úÖ Sent Successfully!");
                else alert("‚ùå Failed to send.");
            } catch (e) { alert("‚ùå Error: " + e.message); }
            
            btn.innerText = originalText;
            btn.style.opacity = "1";
        }

        // --- LIBRARY LOGIC ---
        function saveIcon() {
            const name = document.getElementById('iconName').value; const url = document.getElementById('iconUrl').value;
            if(!name || !url) return alert("Fill Name and URL");
            icons.push({ name, url }); localStorage.setItem('notifyIcons', JSON.stringify(icons)); renderIcons();
            document.getElementById('iconName').value=""; document.getElementById('iconUrl').value="";
        }
        function renderIcons() {
            const list = document.getElementById('iconList'); list.innerHTML = "";
            icons.forEach((icon, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<div style="display:flex; align-items:center;"><img src="${icon.url}" class="icon-preview" onerror="this.src='https://via.placeholder.com/30'"><span>${icon.name}</span></div><div><button class="btn-use" onclick="selectIcon('${icon.url}')">Use</button><button class="btn-del" onclick="deleteIcon(${index})">‚úï</button></div>`;
                list.appendChild(li);
            });
        }
        function deleteIcon(i) { icons.splice(i, 1); localStorage.setItem('notifyIcons', JSON.stringify(icons)); renderIcons(); }
        function selectIcon(url) { document.getElementById('currentIconUrl').value = url; document.getElementById('useIcon').checked = true; updateUserPref(); }

        // --- USER LOGIC ---
        function saveNewUser() {
            const name = document.getElementById('newUserName').value; const code = document.getElementById('newUserCode').value;
            if(!name || !code) return alert("Fill Name and Code");
            try { users.push({ name: name, sub: JSON.parse(code), prefIcon: "" }); localStorage.setItem('notifyUsers', JSON.stringify(users)); refreshAll(); document.getElementById('newUserName').value=""; document.getElementById('newUserCode').value=""; } 
            catch(e) { alert("Invalid Code."); }
        }
        function renderUserDropdown() {
            const select = document.getElementById('userSelect'); const currentVal = select.value; select.innerHTML = "";
            if(users.length === 0) { select.add(new Option("No users found", "")); return; }
            users.forEach((u, i) => { select.add(new Option(u.name, i)); });
            if(currentVal && users[currentVal]) select.value = currentVal; loadUserPreferences();
        }
        function renderManageList() {
            const list = document.getElementById('manageUserList'); list.innerHTML = "";
            users.forEach((u, i) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${u.name}</span><div style="display:flex;"><button class="btn-edit" onclick="editUser(${i})">‚úèÔ∏è</button><button class="btn-del" onclick="deleteUser(${i})">üóëÔ∏è</button></div>`;
                list.appendChild(li);
            });
        }
        function deleteUser(i) { if(confirm("Delete " + users[i].name + "?")) { users.splice(i, 1); localStorage.setItem('notifyUsers', JSON.stringify(users)); refreshAll(); } }
        function editUser(i) { const n = prompt("Edit Name:", users[i].name); if(n) { users[i].name = n; localStorage.setItem('notifyUsers', JSON.stringify(users)); refreshAll(); } }
        function loadUserPreferences() {
            const i = document.getElementById('userSelect').value; if(i === "") return;
            const u = users[i];
            if(u.prefIcon) { document.getElementById('currentIconUrl').value = u.prefIcon; document.getElementById('useIcon').checked = true; }
            else { document.getElementById('currentIconUrl').value = ""; document.getElementById('useIcon').checked = false; }
        }
        function updateUserPref() {
            const i = document.getElementById('userSelect').value; if(i === "") return;
            const url = document.getElementById('currentIconUrl').value; const isEnabled = document.getElementById('useIcon').checked;
            users[i].prefIcon = isEnabled ? url : ""; localStorage.setItem('notifyUsers', JSON.stringify(users));
        }
        function toggleIcon() { updateUserPref(); }
    </script>
</body>
</html>
